{% extends "base.html" %}

{% block title %}Seats - Vagon API Example{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-vagon-900">Computers</h1>
            <p class="mt-1 text-sm text-vagon-500">{{ count }} computers in your team</p>
        </div>

        <!-- Search -->
        <form method="GET" class="flex items-center space-x-2">
            <input type="text"
                   name="q"
                   value="{{ query or '' }}"
                   placeholder="Search seats..."
                   class="px-4 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
            <button type="submit" class="px-4 py-2 bg-vagon-800 text-white rounded-lg text-sm hover:bg-vagon-700">
                Search
            </button>
        </form>
    </div>

    <!-- Seats Table -->
    <div class="bg-white rounded-lg border border-vagon-200 overflow-hidden">
        <table class="min-w-full divide-y divide-vagon-200">
            <thead class="bg-vagon-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Seat</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Usage</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Performance</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-vagon-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-vagon-200">
                {% for seat in seats %}
                <tr class="hover:bg-vagon-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <a href="{{ url_for('seat_detail', seat_id=seat.id) }}" class="text-sm font-medium text-vagon-900 hover:text-vagon-600">
                            {{ seat.name or 'Seat #' ~ seat.id }}
                        </a>
                        <p class="text-xs text-vagon-500">ID: {{ seat.id }}</p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if seat.machine %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium status-{{ seat.machine.status }}">
                                <span class="w-2 h-2 mr-1.5 rounded-full bg-current"></span>
                                {{ seat.machine.friendly_status or seat.machine.status }}
                            </span>
                        {% else %}
                            <span class="text-vagon-400 text-sm">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <p class="text-sm text-vagon-900 usage-display" 
                           data-seat-id="{{ seat.id }}"
                           data-remaining-usage="{{ seat.remaining_usage or 0 }}"
                           data-machine-type="{{ seat.machine.machine_type if seat.machine and seat.machine.machine_type else '' }}">
                            {{ (seat.remaining_usage or 0) | format_usage_with_machine_type(seat.machine.machine_type if seat.machine and seat.machine.machine_type else None) }}
                        </p>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if seat.machine %}
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-vagon-900">{{ seat.machine.machine_type or 'No machine type' }}</span>
                                <button onclick="openPerformanceModal({{ seat.id }}, {{ seat.machine.id }}, '{{ seat.machine.machine_type if seat.machine.machine_type else '' }}', '{{ seat.machine.status if seat.machine else '' }}')"
                                        class="text-vagon-400 hover:text-vagon-600 cursor-pointer"
                                        title="Edit machine type">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                            </div>
                        {% else %}
                            <span class="text-sm text-vagon-400">-</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        {% if seat.machine %}
                            <div class="flex items-center justify-end space-x-2">
                                {% if seat.machine.status == 'stopped' %}
                                    <button onclick="startMachine({{ seat.machine.id }})"
                                            class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200">
                                        Start
                                    </button>
                                {% elif seat.machine.status == 'running' %}
                                    <button onclick="stopMachine({{ seat.machine.id }})"
                                            class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                        Stop
                                    </button>
                                    <button onclick="createAccess({{ seat.machine.id }})"
                                            class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                        Access
                                    </button>
                                {% else %}
                                    <span class="text-xs text-vagon-400">{{ seat.machine.friendly_status or seat.machine.status }}...</span>
                                {% endif %}
                                <a href="{{ url_for('seat_detail', seat_id=seat.id) }}"
                                   class="px-3 py-1 text-xs bg-vagon-100 text-vagon-700 rounded hover:bg-vagon-200">
                                    Files
                                </a>
                            </div>
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" class="px-6 py-12 text-center text-vagon-500">
                        No seats found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if next_page or page > 1 %}
    <div class="flex justify-between items-center">
        <div>
            {% if page > 1 %}
                <a href="?page={{ page - 1 }}{% if query %}&q={{ query }}{% endif %}"
                   class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Previous
                </a>
            {% endif %}
        </div>
        <span class="text-sm text-vagon-500">Page {{ page }}</span>
        <div>
            {% if next_page %}
                <a href="?page={{ next_page }}{% if query %}&q={{ query }}{% endif %}"
                   class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Next
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Performance (Machine Type) Modal -->
<div id="performanceModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-vagon-900 mb-4">Change Machine Type</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Machine Type</label>
                <select id="performanceMachineTypeSelect"
                        class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
                    <option value="" disabled>Loading...</option>
                </select>
                <p id="performanceModalMessage" class="text-xs text-vagon-400 mt-1 hidden"></p>
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="closePerformanceModal()"
                        class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Cancel
                </button>
                <button id="savePerformanceButton" onclick="savePerformanceChange()"
                        class="px-4 py-2 text-sm bg-vagon-800 text-white rounded-lg hover:bg-vagon-700">
                    Save
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Access Link Modal -->
<div id="accessModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
        <h3 class="text-lg font-medium text-vagon-900 mb-4">Machine Access Link</h3>
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Connection Link</label>
                <input type="text" id="accessLink" readonly
                       class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm bg-vagon-50">
            </div>
            <div class="flex justify-end space-x-2">
                <button onclick="copyAccessLink()"
                        class="px-4 py-2 text-sm bg-vagon-800 text-white rounded-lg hover:bg-vagon-700">
                    Copy Link
                </button>
                <button onclick="closeAccessModal()"
                        class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function startMachine(machineId) {
        try {
            await apiCall(`/api/machines/${machineId}/start`, 'POST');
            showToast('Machine start initiated');
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            showToast('Error: ' + error.message);
        }
    }

    async function stopMachine(machineId) {
        if (!confirm('Are you sure you want to stop this machine?')) return;

        try {
            await apiCall(`/api/machines/${machineId}/stop`, 'POST');
            showToast('Machine stop initiated');
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            showToast('Error: ' + error.message);
        }
    }

    async function createAccess(machineId) {
        // Show duration selection modal first
        const durationMinutes = prompt('Enter access link duration in minutes (e.g., 60 = 1 hour, 30 = 30 minutes):', '60');
        
        if (!durationMinutes || isNaN(durationMinutes) || durationMinutes <= 0) {
            showToast('Please enter a valid duration');
            return;
        }
        
        // Convert minutes to seconds
        const expiresInSeconds = parseInt(durationMinutes) * 60;
        
        try {
            const result = await apiCall(`/api/machines/${machineId}/access`, 'POST', {
                expires_in: expiresInSeconds
            });

            document.getElementById('accessLink').value = result.connection_link;
            
            document.getElementById('accessModal').classList.remove('hidden');
            document.getElementById('accessModal').classList.add('flex');
        } catch (error) {
            showToast('Error: ' + error.message);
        }
    }

    function closeAccessModal() {
        document.getElementById('accessModal').classList.add('hidden');
        document.getElementById('accessModal').classList.remove('flex');
    }

    function copyAccessLink() {
        const input = document.getElementById('accessLink');
        input.select();
        document.execCommand('copy');
        showToast('Link copied to clipboard');
    }

    // Update usage displays with friendly machine type names
    async function updateUsageDisplays() {
        const usageDisplays = document.querySelectorAll('.usage-display');
        const seatIds = Array.from(usageDisplays).map(el => el.getAttribute('data-seat-id'));
        
        // Load machine types for all seats
        const machineTypesMap = new Map();
        for (const seatId of seatIds) {
            try {
                const result = await apiCall(`/api/seats/${seatId}/available-machine-types`);
                const machineTypes = result.machine_types || [];
                machineTypesMap.set(seatId, machineTypes);
            } catch (error) {
                console.error(`Error loading machine types for seat ${seatId}:`, error);
            }
        }
        
        // Update each usage display
        usageDisplays.forEach(display => {
            const seatId = display.getAttribute('data-seat-id');
            const remainingUsage = parseInt(display.getAttribute('data-remaining-usage') || 0);
            const machineType = display.getAttribute('data-machine-type');
            const machineTypes = machineTypesMap.get(seatId) || [];
            
            // Find friendly name for current machine type
            let friendlyName = machineType;
            for (const mt of machineTypes) {
                if (mt.name === machineType || mt.friendly_name === machineType) {
                    friendlyName = mt.friendly_name || mt.name;
                    break;
                }
            }
            
            // Format the usage
            const hours = Math.floor(remainingUsage / 60);
            const minutes = remainingUsage % 60;
            let formattedTime = '';
            
            if (hours === 0) {
                if (minutes === 0) {
                    formattedTime = '0 hours 0 minutes';
                } else if (minutes === 1) {
                    formattedTime = '0 hours 1 minute';
                } else {
                    formattedTime = `0 hours ${minutes} minutes`;
                }
            } else {
                if (minutes === 0) {
                    if (hours === 1) {
                        formattedTime = '1 hour 0 minutes';
                    } else {
                        formattedTime = `${hours} hours 0 minutes`;
                    }
                } else {
                    if (hours === 1) {
                        if (minutes === 1) {
                            formattedTime = '1 hour 1 minute';
                        } else {
                            formattedTime = `1 hour ${minutes} minutes`;
                        }
                    } else {
                        if (minutes === 1) {
                            formattedTime = `${hours} hours 1 minute`;
                        } else {
                            formattedTime = `${hours} hours ${minutes} minutes`;
                        }
                    }
                }
            }
            
            display.textContent = `${formattedTime} of ${friendlyName} usage`;
        });
    }
    
    // Update usage displays on page load
    updateUsageDisplays();

    // Performance modal state
    let currentPerformanceSeatId = null;
    let currentPerformanceMachineId = null;
    
    // Open performance modal
    async function openPerformanceModal(seatId, machineId, currentMachineType, machineStatus) {
        currentPerformanceSeatId = seatId;
        currentPerformanceMachineId = machineId;
        
        const modal = document.getElementById('performanceModal');
        const select = document.getElementById('performanceMachineTypeSelect');
        const messageEl = document.getElementById('performanceModalMessage');
        const saveButton = document.getElementById('savePerformanceButton');
        
        // Check if machine is stopped
        const isStopped = machineStatus === 'stopped';
        
        // Enable/disable dropdown and save button based on machine status
        if (isStopped) {
            select.disabled = false;
            select.classList.remove('bg-vagon-50', 'text-vagon-500', 'cursor-not-allowed');
            select.classList.add('bg-white');
            select.removeAttribute('title');
            messageEl.classList.add('hidden');
            messageEl.textContent = '';
            saveButton.disabled = false;
            saveButton.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            select.disabled = true;
            select.classList.add('bg-vagon-50', 'text-vagon-500', 'cursor-not-allowed');
            select.classList.remove('bg-white');
            select.setAttribute('title', 'Machine must be stopped to change type');
            messageEl.classList.remove('hidden');
            messageEl.textContent = 'Machine must be stopped to change type';
            saveButton.disabled = true;
            saveButton.classList.add('opacity-50', 'cursor-not-allowed');
        }
        
        // Show modal
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        
        // Load machine types
        select.innerHTML = '<option value="" disabled>Loading...</option>';
        
        try {
            const result = await apiCall(`/api/seats/${seatId}/available-machine-types`);
            const machineTypes = result.machine_types || [];
            
            select.innerHTML = '';
            
            if (machineTypes.length === 0) {
                select.innerHTML = '<option value="">No types available</option>';
                return;
            }
            
            let selectedFound = false;
            
            // Add options
            machineTypes.forEach(mt => {
                const option = document.createElement('option');
                option.value = mt.id;
                const displayName = mt.friendly_name || mt.name || `Machine Type ${mt.id}`;
                option.textContent = displayName;
                
                // Try to match current machine type
                if (currentMachineType && (mt.name === currentMachineType || mt.friendly_name === currentMachineType)) {
                    option.selected = true;
                    selectedFound = true;
                }
                
                select.appendChild(option);
            });
            
            // If no match found and we have a current type, add it as disabled option
            if (!selectedFound && currentMachineType) {
                const placeholderOption = document.createElement('option');
                placeholderOption.value = '';
                placeholderOption.textContent = `Current: ${currentMachineType}`;
                placeholderOption.disabled = true;
                select.insertBefore(placeholderOption, select.firstChild);
            }
            
        } catch (error) {
            console.error('Error loading machine types:', error);
            select.innerHTML = '<option value="">Error loading types</option>';
        }
    }
    
    // Close performance modal
    function closePerformanceModal() {
        const modal = document.getElementById('performanceModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentPerformanceSeatId = null;
        currentPerformanceMachineId = null;
    }
    
    // Save performance change
    async function savePerformanceChange() {
        const select = document.getElementById('performanceMachineTypeSelect');
        const machineTypeId = select.value;
        
        // Check if dropdown is disabled (machine not stopped)
        if (select.disabled) {
            showToast('Machine must be stopped to change type');
            return;
        }
        
        if (!machineTypeId || !currentPerformanceMachineId) {
            showToast('Please select a machine type');
            return;
        }
        
        if (!confirm('Are you sure you want to change the machine type? This will take effect on the next machine start.')) {
            return;
        }
        
        try {
            await apiCall(`/api/machines/${currentPerformanceMachineId}/machine-type`, 'POST', {
                machine_type_id: parseInt(machineTypeId)
            });
            showToast('Machine type updated successfully');
            closePerformanceModal();
            // Reload page after a short delay to show updated info
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            showToast('Error: ' + error.message);
        }
    }
    
</script>
{% endblock %}
