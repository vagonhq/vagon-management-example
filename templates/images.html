{% extends "base.html" %}

{% block title %}Images - Vagon API Example{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-vagon-900">Images</h1>
            <p class="mt-1 text-sm text-vagon-500">{{ count }} images in your organization</p>
        </div>

        <div class="flex items-center space-x-2">
            <!-- Search -->
            <form method="GET" class="flex items-center space-x-2">
                <input type="text"
                       name="q"
                       value="{{ query or '' }}"
                       placeholder="Search images..."
                       class="px-4 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
                <button type="submit" class="px-4 py-2 bg-vagon-800 text-white rounded-lg text-sm hover:bg-vagon-700">
                    Search
                </button>
            </form>
            <!-- Create Image from Pre-installation Button -->
            <button onclick="openInstallImageModal()"
                    class="px-4 py-2 bg-vagon-800 text-white rounded-lg text-sm hover:bg-vagon-700 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                <span>Create from Software</span>
            </button>
            <!-- Create Image from Machine Button -->
            <button onclick="openCreateImageFromMachineModal()"
                    class="px-4 py-2 bg-vagon-600 text-white rounded-lg text-sm hover:bg-vagon-500 flex items-center space-x-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                <span>Create from Machine</span>
            </button>
        </div>
    </div>

    <!-- Images Table -->
    <div class="bg-white rounded-lg border border-vagon-200 overflow-hidden">
        <table class="min-w-full divide-y divide-vagon-200">
            <thead class="bg-vagon-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Size</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Source</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Software</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-vagon-500 uppercase tracking-wider">Created</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-vagon-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-vagon-200">
                {% for image in images %}
                <tr class="hover:bg-vagon-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-vagon-900">
                            {{ image.name or 'Image #' ~ image.id }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                            {% if image.status == 'available' %}bg-green-100 text-green-800
                            {% elif image.status == 'pending' %}bg-yellow-100 text-yellow-800
                            {% elif image.status == 'building' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ image.status }}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-vagon-900">
                            {{ (image.size / (1024**3)) | round(2) }} GB
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-vagon-900">
                            {% if image.source == 'pre_installation' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800">
                                    Pre-installation
                                </span>
                            {% elif image.source == 'seat' %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    From Machine
                                </span>
                            {% else %}
                                {{ image.source or 'N/A' }}
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-vagon-900">
                            {% if image.softwares %}
                                {% if image.softwares is string %}
                                    <span class="text-vagon-400">None</span>
                                {% elif image.softwares|length > 0 %}
                                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">
                                        {{ image.softwares|length }} software
                                    </span>
                                {% else %}
                                    <span class="text-vagon-400">None</span>
                                {% endif %}
                            {% else %}
                                <span class="text-vagon-400">None</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-vagon-500">
                            {{ image.created_at if image.created_at else 'N/A' }}
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right">
                        <div class="flex items-center justify-end space-x-2">
                            {% if image.status == 'available' %}
                                <button onclick="openAssignImageModal({{ image.id }}, '{{ (image.name or 'Image #' ~ image.id)|replace("'", "\\'") }}')"
                                        class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                                    Assign
                                </button>
                            {% else %}
                                <button disabled
                                        class="px-3 py-1 text-xs bg-gray-100 text-gray-400 rounded cursor-not-allowed"
                                        title="Image must be available to assign">
                                    Assign
                                </button>
                            {% endif %}
                            <button onclick="deleteImage({{ image.id }}, '{{ (image.name or 'Image #' ~ image.id)|replace("'", "\\'") }}')"
                                    class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200">
                                Delete
                            </button>
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center text-vagon-500">
                        No images found
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if next_page or page > 1 %}
    <div class="flex justify-between items-center">
        <div>
            {% if page > 1 %}
                <a href="?page={{ page - 1 }}{% if query %}&q={{ query }}{% endif %}"
                   class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Previous
                </a>
            {% endif %}
        </div>
        <span class="text-sm text-vagon-500">Page {{ page }}</span>
        <div>
            {% if next_page %}
                <a href="?page={{ next_page }}{% if query %}&q={{ query }}{% endif %}"
                   class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Next
                </a>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Install Image Modal (from pre-installation) -->
<div id="installImageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeInstallImageModal()">
    <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
        <h3 class="text-lg font-medium text-vagon-900 mb-4">Create Image from Software</h3>
        <div class="space-y-4">
            <!-- Name -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Image Name (Optional)</label>
                <input type="text" id="installImageName"
                       placeholder="Leave empty for auto-generated name"
                       class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
            </div>

            <!-- Base Image -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Base Image (Optional)</label>
                <select id="installImageBaseImage"
                        class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
                    <option value="">Use default</option>
                </select>
            </div>

            <!-- Software Selection -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Software (Optional)</label>
                <div id="installImageSoftwareList" class="border border-vagon-300 rounded-lg p-3 max-h-48 overflow-y-auto space-y-2">
                    <p class="text-sm text-vagon-400">Loading software...</p>
                </div>
                <p class="text-xs text-vagon-400 mt-1">Select software to pre-install. At least one software or non-base image type is required.</p>
            </div>

            <!-- Error Message -->
            <div id="installImageError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="text-sm text-red-600" id="installImageErrorMessage"></p>
            </div>

            <!-- Success Message -->
            <div id="installImageSuccess" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                <p class="text-sm text-green-600" id="installImageSuccessMessage"></p>
            </div>

            <!-- Loading Indicator -->
            <div id="installImageLoading" class="hidden text-center">
                <p class="text-sm text-vagon-500">Creating image...</p>
            </div>

            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="closeInstallImageModal()"
                        class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Cancel
                </button>
                <button id="installImageButton" onclick="installImage()"
                        class="px-4 py-2 text-sm bg-vagon-800 text-white rounded-lg hover:bg-vagon-700">
                    Create Image
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Create Image from Machine Modal -->
<div id="createImageFromMachineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeCreateImageFromMachineModal()">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <h3 class="text-lg font-medium text-vagon-900 mb-4">Create Image from Machine</h3>
        <div class="space-y-4">
            <!-- Machine Selection -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Machine <span class="text-red-500">*</span></label>
                <select id="createImageMachineId"
                        class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
                    <option value="">Select a machine...</option>
                </select>
                <p class="text-xs text-vagon-400 mt-1">Machine must be stopped (off) to create an image</p>
            </div>

            <!-- Name -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Image Name (Optional)</label>
                <input type="text" id="createImageName"
                       placeholder="Leave empty for auto-generated name"
                       class="w-full px-3 py-2 border border-vagon-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-vagon-500">
            </div>

            <!-- Error Message -->
            <div id="createImageError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="text-sm text-red-600" id="createImageErrorMessage"></p>
            </div>

            <!-- Success Message -->
            <div id="createImageSuccess" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                <p class="text-sm text-green-600" id="createImageSuccessMessage"></p>
            </div>

            <!-- Loading Indicator -->
            <div id="createImageLoading" class="hidden text-center">
                <p class="text-sm text-vagon-500">Creating image...</p>
            </div>

            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="closeCreateImageFromMachineModal()"
                        class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Cancel
                </button>
                <button id="createImageButton" onclick="createImageFromMachine()"
                        class="px-4 py-2 text-sm bg-vagon-800 text-white rounded-lg hover:bg-vagon-700">
                    Create Image
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Assign Image Modal -->
<div id="assignImageModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50" onclick="if(event.target === this) closeAssignImageModal()">
    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
        <h3 class="text-lg font-medium text-vagon-900 mb-4">Assign Image to Machines</h3>
        <div class="space-y-4">
            <div>
                <p class="text-sm text-vagon-600 mb-2">Image: <span id="assignImageName" class="font-medium"></span></p>
                <p class="text-xs text-vagon-400 mb-4">This will terminate the selected machines and assign this image to them.</p>
            </div>

            <!-- Machine Selection -->
            <div>
                <label class="block text-sm text-vagon-600 mb-1">Select Machines <span class="text-red-500">*</span></label>
                <div id="assignImageMachineList" class="border border-vagon-300 rounded-lg p-3 max-h-64 overflow-y-auto space-y-2">
                    <p class="text-sm text-vagon-400">Loading machines...</p>
                </div>
            </div>

            <!-- Error Message -->
            <div id="assignImageError" class="hidden bg-red-50 border border-red-200 rounded-lg p-3">
                <p class="text-sm text-red-600" id="assignImageErrorMessage"></p>
            </div>

            <!-- Success Message -->
            <div id="assignImageSuccess" class="hidden bg-green-50 border border-green-200 rounded-lg p-3">
                <p class="text-sm text-green-600" id="assignImageSuccessMessage"></p>
            </div>

            <!-- Loading Indicator -->
            <div id="assignImageLoading" class="hidden text-center">
                <p class="text-sm text-vagon-500">Assigning image...</p>
            </div>

            <div class="flex justify-end space-x-2 pt-4">
                <button onclick="closeAssignImageModal()"
                        class="px-4 py-2 text-sm border border-vagon-300 rounded-lg hover:bg-vagon-50">
                    Cancel
                </button>
                <button id="assignImageButton" onclick="assignImage()"
                        class="px-4 py-2 text-sm bg-vagon-800 text-white rounded-lg hover:bg-vagon-700">
                    Assign
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let softwaresData = null;
    let goldenImagesData = null;
    let currentAssignImageId = null;
    let machinesData = null;

    // =============================================================================
    // INSTALL IMAGE MODAL (from pre-installation)
    // =============================================================================

    async function openInstallImageModal() {
        const modal = document.getElementById('installImageModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Reset form
        document.getElementById('installImageName').value = '';
        document.getElementById('installImageBaseImage').innerHTML = '<option value="">Use default</option>';
        document.getElementById('installImageError').classList.add('hidden');
        document.getElementById('installImageSuccess').classList.add('hidden');
        document.getElementById('installImageLoading').classList.add('hidden');

        // Load softwares and golden images
        if (!softwaresData || !goldenImagesData) {
            await loadSoftwaresAndImages();
        } else {
            populateInstallSoftwareList();
            populateInstallBaseImageSelect();
        }
    }

    function closeInstallImageModal() {
        const modal = document.getElementById('installImageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    async function loadSoftwaresAndImages() {
        const softwareList = document.getElementById('installImageSoftwareList');
        const baseImageSelect = document.getElementById('installImageBaseImage');

        try {
            softwareList.innerHTML = '<p class="text-sm text-vagon-400">Loading software...</p>';
            baseImageSelect.innerHTML = '<option value="">Loading...</option>';

            const response = await fetch('/api/software');
            if (!response.ok) {
                throw new Error('Failed to load softwares');
            }

            const data = await response.json();
            softwaresData = data.softwares || [];
            goldenImagesData = data.base_images || [];

            populateInstallSoftwareList();
            populateInstallBaseImageSelect();
        } catch (error) {
            console.error('Error loading softwares:', error);
            softwareList.innerHTML = '<p class="text-sm text-red-600">Error loading software. Please try again.</p>';
            baseImageSelect.innerHTML = '<option value="">Error loading images</option>';
        }
    }

    function populateInstallSoftwareList() {
        const softwareList = document.getElementById('installImageSoftwareList');
        
        if (!softwaresData || softwaresData.length === 0) {
            softwareList.innerHTML = '<p class="text-sm text-vagon-400">No software available</p>';
            return;
        }

        softwareList.innerHTML = '';
        softwaresData.forEach(software => {
            const softwareItem = document.createElement('div');
            softwareItem.className = 'flex items-center space-x-2';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `install-software-${software.id}`;
            checkbox.value = software.id;
            checkbox.className = 'rounded border-vagon-300 text-vagon-600 focus:ring-vagon-500';

            const label = document.createElement('label');
            label.htmlFor = `install-software-${software.id}`;
            label.className = 'text-sm text-vagon-700 cursor-pointer flex-1';
            label.innerHTML = `${software.name} <span class="text-vagon-400">(${software.size} GB)</span>`;

            softwareItem.appendChild(checkbox);
            softwareItem.appendChild(label);
            softwareList.appendChild(softwareItem);
        });
    }

    function populateInstallBaseImageSelect() {
        const baseImageSelect = document.getElementById('installImageBaseImage');
        
        baseImageSelect.innerHTML = '<option value="">Use default</option>';
        
        if (goldenImagesData && goldenImagesData.length > 0) {
            goldenImagesData.forEach(image => {
                const option = document.createElement('option');
                option.value = image.id;
                option.textContent = `${image.name} (${image.size} GB)`;
                baseImageSelect.appendChild(option);
            });
        }
    }

    async function installImage() {
        const name = document.getElementById('installImageName').value.trim();
        const baseImageId = document.getElementById('installImageBaseImage').value;
        
        // Get selected software IDs
        const softwareCheckboxes = document.querySelectorAll('#installImageSoftwareList input[type="checkbox"]:checked');
        const softwareIds = Array.from(softwareCheckboxes).map(cb => parseInt(cb.value));

        // Validation: at least one software or non-default base image
        if (softwareIds.length === 0 && !baseImageId) {
            showInstallImageError('Please select at least one software or a base image');
            return;
        }

        // Hide previous messages
        document.getElementById('installImageError').classList.add('hidden');
        document.getElementById('installImageSuccess').classList.add('hidden');
        document.getElementById('installImageLoading').classList.remove('hidden');
        document.getElementById('installImageButton').disabled = true;

        try {
            const payload = {};
            if (name) payload.name = name;
            if (baseImageId) payload.base_image_id = parseInt(baseImageId);
            if (softwareIds.length > 0) payload.software_ids = softwareIds;

            const response = await fetch('/api/images/install', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to create image');
            }

            // Show success message
            document.getElementById('installImageLoading').classList.add('hidden');
            document.getElementById('installImageSuccessMessage').textContent = 'Image created successfully!';
            document.getElementById('installImageSuccess').classList.remove('hidden');

            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 2000);

        } catch (error) {
            console.error('Error creating image:', error);
            document.getElementById('installImageLoading').classList.add('hidden');
            showInstallImageError(error.message || 'Failed to create image. Please try again.');
        } finally {
            document.getElementById('installImageButton').disabled = false;
        }
    }

    function showInstallImageError(message) {
        const errorDiv = document.getElementById('installImageError');
        const errorMessage = document.getElementById('installImageErrorMessage');
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    // =============================================================================
    // CREATE IMAGE FROM MACHINE MODAL
    // =============================================================================

    async function openCreateImageFromMachineModal() {
        const modal = document.getElementById('createImageFromMachineModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        // Reset form
        document.getElementById('createImageName').value = '';
        document.getElementById('createImageError').classList.add('hidden');
        document.getElementById('createImageSuccess').classList.add('hidden');
        document.getElementById('createImageLoading').classList.add('hidden');

        // Load machines
        await loadMachinesForImage();
    }

    function closeCreateImageFromMachineModal() {
        const modal = document.getElementById('createImageFromMachineModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    async function loadMachinesForImage() {
        const machineSelect = document.getElementById('createImageMachineId');
        machineSelect.innerHTML = '<option value="">Select a machine...</option>';

        // Use machines passed from backend
        {% for machine in machines %}
        const option{{ machine.id }} = document.createElement('option');
        option{{ machine.id }}.value = {{ machine.id }};
        option{{ machine.id }}.textContent = '{{ machine.name or "Machine #" ~ machine.id }} ({{ machine.friendly_status }})';
        {% if machine.friendly_status != 'off' %}
        option{{ machine.id }}.disabled = true;
        option{{ machine.id }}.textContent += ' - Must be stopped';
        {% endif %}
        machineSelect.appendChild(option{{ machine.id }});
        {% endfor %}
    }

    function populateMachineSelect() {
        const machineSelect = document.getElementById('createImageMachineId');
        machineSelect.innerHTML = '<option value="">Select a machine...</option>';

        if (machinesData && machinesData.length > 0) {
            machinesData.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.id;
                const isOff = machine.friendly_status === 'off';
                option.textContent = `${machine.name || 'Machine #' + machine.id} (${machine.friendly_status})`;
                if (!isOff) {
                    option.disabled = true;
                    option.textContent += ' - Must be stopped';
                }
                machineSelect.appendChild(option);
            });
        }
    }

    async function createImageFromMachine() {
        const machineId = document.getElementById('createImageMachineId').value;
        const name = document.getElementById('createImageName').value.trim();

        if (!machineId) {
            showCreateImageError('Please select a machine');
            return;
        }

        // Hide previous messages
        document.getElementById('createImageError').classList.add('hidden');
        document.getElementById('createImageSuccess').classList.add('hidden');
        document.getElementById('createImageLoading').classList.remove('hidden');
        document.getElementById('createImageButton').disabled = true;

        try {
            const payload = { machine_id: parseInt(machineId) };
            if (name) payload.name = name;

            const response = await fetch('/api/images', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to create image');
            }

            // Show success message
            document.getElementById('createImageLoading').classList.add('hidden');
            document.getElementById('createImageSuccessMessage').textContent = 'Image created successfully!';
            document.getElementById('createImageSuccess').classList.remove('hidden');

            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 2000);

        } catch (error) {
            console.error('Error creating image:', error);
            document.getElementById('createImageLoading').classList.add('hidden');
            showCreateImageError(error.message || 'Failed to create image. Please try again.');
        } finally {
            document.getElementById('createImageButton').disabled = false;
        }
    }

    function showCreateImageError(message) {
        const errorDiv = document.getElementById('createImageError');
        const errorMessage = document.getElementById('createImageErrorMessage');
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    // =============================================================================
    // ASSIGN IMAGE MODAL
    // =============================================================================

    async function openAssignImageModal(imageId, imageName) {
        currentAssignImageId = imageId;
        const modal = document.getElementById('assignImageModal');
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        document.getElementById('assignImageName').textContent = imageName || `Image #${imageId}`;
        document.getElementById('assignImageError').classList.add('hidden');
        document.getElementById('assignImageSuccess').classList.add('hidden');
        document.getElementById('assignImageLoading').classList.add('hidden');

        // Load machines
        await loadMachinesForAssign();
    }

    function closeAssignImageModal() {
        const modal = document.getElementById('assignImageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        currentAssignImageId = null;
    }

    async function loadMachinesForAssign() {
        const machineList = document.getElementById('assignImageMachineList');

        try {
            machineList.innerHTML = '<p class="text-sm text-vagon-400">Loading machines...</p>';

            const response = await fetch('/api/machines?per_page=100');
            if (!response.ok) {
                throw new Error('Failed to load machines');
            }

            const data = await response.json();
            machinesData = data.machines || [];

            populateAssignMachineList();
        } catch (error) {
            console.error('Error loading machines:', error);
            machineList.innerHTML = '<p class="text-sm text-red-600">Error loading machines. Please try again.</p>';
        }
    }

    function populateAssignMachineList() {
        const machineList = document.getElementById('assignImageMachineList');
        
        if (!machinesData || machinesData.length === 0) {
            machineList.innerHTML = '<p class="text-sm text-vagon-400">No machines available</p>';
            return;
        }

        machineList.innerHTML = '';
        machinesData.forEach(machine => {
            const machineItem = document.createElement('div');
            machineItem.className = 'flex items-center space-x-2';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `assign-machine-${machine.id}`;
            checkbox.value = machine.id;
            checkbox.className = 'rounded border-vagon-300 text-vagon-600 focus:ring-vagon-500';

            const label = document.createElement('label');
            label.htmlFor = `assign-machine-${machine.id}`;
            label.className = 'text-sm text-vagon-700 cursor-pointer flex-1';
            label.textContent = `${machine.name || 'Machine #' + machine.id} (${machine.friendly_status})`;

            machineItem.appendChild(checkbox);
            machineItem.appendChild(label);
            machineList.appendChild(machineItem);
        });
    }

    async function assignImage() {
        if (!currentAssignImageId) {
            showAssignImageError('No image selected');
            return;
        }

        // Get selected machine IDs
        const machineCheckboxes = document.querySelectorAll('#assignImageMachineList input[type="checkbox"]:checked');
        const machineIds = Array.from(machineCheckboxes).map(cb => parseInt(cb.value));

        if (machineIds.length === 0) {
            showAssignImageError('Please select at least one machine');
            return;
        }

        if (!confirm(`Are you sure you want to assign this image to ${machineIds.length} machine(s)? This will terminate the selected machines.`)) {
            return;
        }

        // Hide previous messages
        document.getElementById('assignImageError').classList.add('hidden');
        document.getElementById('assignImageSuccess').classList.add('hidden');
        document.getElementById('assignImageLoading').classList.remove('hidden');
        document.getElementById('assignImageButton').disabled = true;

        try {
            const response = await fetch(`/api/images/${currentAssignImageId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ machine_ids: machineIds })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to assign image');
            }

            // Show success message
            document.getElementById('assignImageLoading').classList.add('hidden');
            document.getElementById('assignImageSuccessMessage').textContent = `Image assigned to ${machineIds.length} machine(s) successfully!`;
            document.getElementById('assignImageSuccess').classList.remove('hidden');

            // Reload page after a short delay
            setTimeout(() => {
                location.reload();
            }, 2000);

        } catch (error) {
            console.error('Error assigning image:', error);
            document.getElementById('assignImageLoading').classList.add('hidden');
            showAssignImageError(error.message || 'Failed to assign image. Please try again.');
        } finally {
            document.getElementById('assignImageButton').disabled = false;
        }
    }

    function showAssignImageError(message) {
        const errorDiv = document.getElementById('assignImageError');
        const errorMessage = document.getElementById('assignImageErrorMessage');
        errorMessage.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    // =============================================================================
    // DELETE IMAGE
    // =============================================================================

    async function deleteImage(imageId, imageName) {
        if (!confirm(`Are you sure you want to delete "${imageName || 'Image #' + imageId}"? This action cannot be undone.`)) {
            return;
        }

        try {
            const response = await fetch(`/api/images/${imageId}`, {
                method: 'DELETE'
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to delete image');
            }

            showToast('Image deleted successfully');
            setTimeout(() => location.reload(), 1500);
        } catch (error) {
            showToast('Error: ' + error.message);
        }
    }
</script>
{% endblock %}
